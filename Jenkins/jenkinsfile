pipeline {
    agent any

    environment {
        AWS_ACCOUNT_ID = '891377165332'
        AWS_REGION = 'eu-central-1'
        ECR_BACKEND_REPO_NAME = 'backend-repo'
        ECR_FRONTEND_REPO_NAME = 'frontend-repo'
        IMAGE_TAG = 'latest'
        TERRAFORM_DIR = 'Terraform'
        KUBECONFIG_PATH = '/home/ec2-user/.kube/config'  // Kubeconfig dosyası
        SSH_KEY_PATH = 'test.pem'  // SSH anahtarının geçici dosya yolu
        ANSIBLE_CFG_PATH = 'ansible.cfg'  // Geçici ansible.cfg dosyası
    }

    stages {
        stage('Checkout Terraform and Ansible Code') {
            steps {
                git branch: 'dev', url: 'https://github.com/DevCloud-Solutions/AI-Application.git'
            }
        }
    stages {
        stage('Terraform Apply') {
            steps {
                withCredentials([file(credentialsId: 'ec2-ssh-key', variable: 'SSH_KEY')]) {
                    sh '''
                        terraform init
                        terraform apply -auto-approve
                        terraform output -json > inventory.json

                        # SSH anahtarını geçici dosyaya kopyala ve izinlerini ayarla
                        cp $SSH_KEY $SSH_KEY_PATH
                        chmod 400 $SSH_KEY_PATH

                        # Python script ile inventory.yaml dosyasını oluştur
                        python3 -c "
import json

with open('inventory.json') as f:
    data = json.load(f)

inventory = {
    'master': {
        'hosts': [data['master_public_ip']['value']]
    },
    'workers': {
        'hosts': data['ec2_public_ips']['value']
    }
}

with open('inventory.yaml', 'w') as f:
    f.write(json.dumps(inventory, indent=2))
"
                    '''
                }
            }
        }
        stage('Create Ansible Config') {
            steps {
                // ansible.cfg dosyasını oluştur
                sh '''
                    cat <<EOF > $ANSIBLE_CFG_PATH
                    [defaults]
                    inventory = ./inventory.yaml
                    host_key_checking = False
                    private_key_file = $SSH_KEY_PATH
                    EOF
                '''
            }
        }

        stage('Ansible Master Setup') {
            steps {
                sh '''
                    ansible-playbook -i inventory.yaml /Ansible/playbooks/master_setup.yml \
                    --private-key $SSH_KEY_PATH
                '''
            }
        }
        stage('Ansible Worker Setup') {
            steps {
                sh '''
                    ansible-playbook -i inventory.yaml /Ansible/playbooks/worker_setup.yml \
                    --private-key $SSH_KEY_PATH
                '''
            }
        }
    }
    post {
        always {
            // Temizlik: Geçici dosyaları sil
            sh 'rm -f $SSH_KEY_PATH $ANSIBLE_CFG_PATH'
        }
    }
}
}

//         stage('Build and Push Docker Images') {
//             steps {
//                 script {
//                     sh '''
//                     docker build -t ${ECR_BACKEND_REPO_NAME}:${IMAGE_TAG} -f backend/Dockerfile .
//                     docker build -t ${ECR_FRONTEND_REPO_NAME}:${IMAGE_TAG} -f frontend/Dockerfile .

//                     aws ecr get-login-password --region ${AWS_REGION} | docker login --username AWS --password-stdin ${AWS_ACCOUNT_ID}.dkr.ecr.${AWS_REGION}.amazonaws.com

//                     docker tag ${ECR_BACKEND_REPO_NAME}:${IMAGE_TAG} ${AWS_ACCOUNT_ID}.dkr.ecr.${AWS_REGION}.amazonaws.com/${ECR_BACKEND_REPO_NAME}:${IMAGE_TAG}
//                     docker push ${AWS_ACCOUNT_ID}.dkr.ecr.${AWS_REGION}.amazonaws.com/${ECR_BACKEND_REPO_NAME}:${IMAGE_TAG}

//                     docker tag ${ECR_FRONTEND_REPO_NAME}:${IMAGE_TAG} ${AWS_ACCOUNT_ID}.dkr.ecr.${AWS_REGION}.amazonaws.com/${ECR_FRONTEND_REPO_NAME}:${IMAGE_TAG}
//                     docker push ${AWS_ACCOUNT_ID}.dkr.ecr.${AWS_REGION}.amazonaws.com/${ECR_FRONTEND_REPO_NAME}:${IMAGE_TAG}
//                     '''
//                 }
//             }
//         }

//         stage('Deploy to Kubernetes') {
//             steps {
//                 script {
//                     withEnv(["KUBECONFIG=${KUBECONFIG_PATH}", "PATH=$PATH:/usr/local/bin"]) {
//                         sh '''
//                         echo "PATH: $PATH"  # PATH kontrolü
//                         echo "Kubeconfig path: $KUBECONFIG"  # Kubeconfig doğrulama
//                         kubectl version --client  # Kubectl erişimini kontrol et
//                         kubectl apply -f kubernetes/backend-deployment.yaml
//                         kubectl apply -f kubernetes/frontend-deployment.yaml
//                         kubectl rollout status deployment/backend-deployment
//                         kubectl rollout status deployment/frontend-deployment
//                         '''
//                     }
//                 }
//             }
//         }
//     }

//     post {
//         always {
//             cleanWs()  // İşlem tamamlandığında workspace temizlenir
//         }
//         failure {
//             dir("${TERRAFORM_DIR}") {
//                 sh 'terraform destroy -auto-approve'  // Başarısızlık durumunda altyapı yok edilir
//             }
//         }
//     }
// }
